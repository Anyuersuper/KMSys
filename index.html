<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¡å¯†ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>ğŸ« å¡å¯†ç®¡ç†ç³»ç»Ÿ</h2>
      <div id="authButtons" class="d-flex gap-2">
        <button class="btn btn-primary" onclick="showLoginModal()" id="loginBtn">ç™»å½•</button>
        <div class="d-flex gap-2" id="loggedInButtons" style="display: none;">
          <button class="btn btn-light border" onclick="showAdminSettings()" id="settingsBtn">è®¾ç½®</button>
          <button class="btn btn-danger" onclick="logout()" id="logoutBtn">é€€å‡º</button>
        </div>
      </div>
    </div>

    <!-- ç”Ÿæˆå¡å¯† -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">ç”Ÿæˆå¡å¯†</h5>
        <label for="validDays">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
        <input type="number" class="form-control mb-2" id="validDays" value="1" min="1">
        <button class="btn btn-primary" onclick="generateToken()" id="generateBtn" disabled>ç”Ÿæˆ</button>
        <p class="mt-2 text-break" id="generatedToken"></p>
      </div>
    </div>

    <!-- æ ¡éªŒå¡å¯† -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">æ ¡éªŒå¡å¯†</h5>
        <input type="text" class="form-control mb-2" id="validateInput" placeholder="è¯·è¾“å…¥å¡å¯†">
        <button class="btn btn-success" onclick="validateToken()">æ ¡éªŒ</button>
        <p class="mt-2" id="validateResult"></p>
      </div>
    </div>

    <!-- å¡å¯†åˆ—è¡¨ -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">å¡å¯†åˆ—è¡¨</h5>
        <button class="btn btn-secondary mb-2" onclick="loadTokens()">åˆ·æ–°åˆ—è¡¨</button>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Token</th>
              <th>åˆ›å»ºæ—¶é—´</th>
            </tr>
          </thead>
          <tbody id="tokenTable"></tbody>
        </table>
        <nav>
          <ul class="pagination" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- ç™»å½•æ¨¡æ€æ¡† -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ç®¡ç†å‘˜ç™»å½•</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ç”¨æˆ·å</label>
            <input type="text" class="form-control" id="username">
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç </label>
            <input type="password" class="form-control" id="password">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="login()">ç™»å½•</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†å‘˜è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="modal fade" id="adminSettingsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä¿®æ”¹ç®¡ç†å‘˜ä¿¡æ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">æ–°ç”¨æˆ·å</label>
            <input type="text" class="form-control" id="newUsername">
          </div>
          <div class="mb-3">
            <label class="form-label">æ–°å¯†ç </label>
            <input type="password" class="form-control" id="newPassword">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="updateAdminCredentials()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPage = 1;
    const pageSize = 10;
    let loginModal;
    let adminSettingsModal;
    

    document.addEventListener('DOMContentLoaded', function() {
      loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      adminSettingsModal = new bootstrap.Modal(document.getElementById('adminSettingsModal'));
      checkAuth();
    });

    function showLoginModal() {
      loginModal.show();
    }

    function showAdminSettings() {
      adminSettingsModal.show();
    }

    async function checkAuth() {
      const res = await fetch('/check-auth');
      const data = await res.json();
      updateAuthUI(data.logged_in);
      if (data.logged_in) {
        document.getElementsByClassName("btn btn-light border")[0].style.display='flex';
        document.getElementsByClassName("btn btn-danger")[0].style.display='flex';
      } else {
        document.getElementsByClassName("btn btn-light border")[0].style.display='none';
        document.getElementsByClassName("btn btn-danger")[0].style.display='none';
      }
    }

    function updateAuthUI(loggedIn) {
      document.getElementById('loginBtn').style.display = loggedIn ? 'none' : 'block';
      document.getElementById('loggedInButtons').style.display = loggedIn ? 'inline-block' : 'none';
      document.getElementById('generateBtn').disabled = !loggedIn;
    }

    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const data = await res.json();
      if (data.success) {
        loginModal.hide();
        updateAuthUI(true);
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æœ€æ–°æ•°æ®
      } else {
        alert('ç™»å½•å¤±è´¥ï¼š' + (data.error || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'));
      }
    }

    async function logout() {
      await fetch('/logout', { method: 'POST' });
      updateAuthUI(false);
      window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æœ€æ–°æ•°æ®
    }

    async function generateToken() {
      const days = parseInt(document.getElementById("validDays").value);
      if (isNaN(days) || days <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°");
        return;
      }

      const res = await fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ days })
      });

      const data = await res.json();
      document.getElementById("generatedToken").textContent = data.token;
      loadTokens(currentPage);
    }

    async function validateToken() {
      const token = document.getElementById("validateInput").value;
      if (!token) {
        alert("è¯·è¾“å…¥å¡å¯†");
        return;
      }

      const res = await fetch("/validate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });

      const data = await res.json();
      const result = document.getElementById("validateResult");

      if (data.valid) {
        result.innerHTML = `<span class="text-success">âœ… æœ‰æ•ˆï¼Œåˆ›å»ºæ—¶é—´ï¼š${data.created_at}</span>`;
      } else {
        result.innerHTML = `<span class="text-danger">âŒ æ— æ•ˆï¼š${data.reason || 'æœªçŸ¥é”™è¯¯'}</span>`;
      }
    }

    async function updateAdminCredentials() {
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;

      if (!newUsername || !newPassword) {
        alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
        return;
      }

      const res = await fetch('/update-admin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          username: newUsername, 
          password: newPassword 
        })
      });

      const data = await res.json();
      if (data.success) {
        alert('ç®¡ç†å‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
        adminSettingsModal.hide();
        updateAuthUI(false);
        window.location.reload(); // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æœ€æ–°æ•°æ®
      } else {
        alert('æ›´æ–°å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    function formatDateTime(utcDateString) {
      const date = new Date(utcDateString);
      // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
      date.setHours(date.getHours() + 8);
      return date.toLocaleString('zh-CN', {
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    }

    async function loadTokens(page = 1) {
      currentPage = page;
      const res = await fetch(`/list?page=${page}&size=${pageSize}`);
      const result = await res.json();
      const tokens = result.data;
      const total = result.total;

      const table = document.getElementById("tokenTable");
      table.innerHTML = "";
      tokens.forEach(t => {
        const row = `<tr><td>${t.id}</td><td class="text-break">${t.token}</td><td>${formatDateTime(t.created_at)}</td></tr>`;
        table.innerHTML += row;
      });

      renderPagination(total, result.page, result.size);
    }

    function renderPagination(total, page, size) {
      const pageCount = Math.ceil(total / size);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= pageCount; i++) {
        pagination.innerHTML += `
          <li class="page-item ${i === page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTokens(${i})">${i}</a>
          </li>`;
      }
    }

    // åˆå§‹åŠ è½½ç¬¬ä¸€é¡µ
    loadTokens();
  </script>
</body>
</html>
